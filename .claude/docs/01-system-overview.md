# System Overview

## 1. プロジェクト背景

さとやま整形外科内科において、患者様が自宅でリハビリ運動を継続的に実施し、その結果を医療スタッフが効率的に確認・管理できるシステムを構築する。患者様の運動習慣の定着と、医療スタッフによる適切なフォローアップを実現することを目的とする。

## 2. システム利用シーン

### 利用者（患者様）

| 項目 | 内容 |
|------|------|
| 利用場所 | 自宅 |
| 利用タイミング | 日常の隙間時間、運動習慣として |
| デバイス | スマートフォン・タブレット |

**典型的な利用シーン:**

患者様は自宅で、朝または夕方などの隙間時間にスマートフォンやタブレットでアプリにアクセスします。ログイン後、ウェルカム画面（U-10）で継続日数を確認し、モチベーションを高めます。運動カード画面（U-11）に本日の運動メニューが表示されるので、動画を見ながら運動を実施します。完了後は祝福画面（U-13）で達成感を得て、体調入力画面（U-14）で当日の痛みレベルや体調を0〜10の数値で記録します。

### 職員（医療スタッフ）

| 項目 | 内容 |
|------|------|
| 利用場所 | 施設内 |
| 利用タイミング | 患者来院時（週1回〜月1回） |
| デバイス | PC・タブレット |

**典型的な利用シーン:**

医療スタッフは患者来院時（週1回〜月1回）に、施設内のタブレットやPCで測定値（膝伸展筋力、バランス評価など）を入力します。また、定期的にダッシュボードで担当患者の運動継続状況を確認し、必要に応じて運動メニューの調整や患者への声かけを行います。

## 3. システムスコープ

| 項目 | 内容 |
|------|------|
| 利用者向けアプリ | Webアプリ（スマートフォン・タブレット対応） |
| 職員向けアプリ | Webアプリ（PC・タブレット対応） |
| 動画配信 | 自社サーバー |
| 提供形態 | ブラウザベースのWebアプリケーション（SPA） |

### Tech Stack

| カテゴリ | 技術 |
|----------|------|
| フロントエンドフレームワーク | React 18 + TypeScript |
| ビルドツール | Vite 6.3.5 |
| CSSフレームワーク | Tailwind CSS v4 |
| UIコンポーネントライブラリ | Radix UI + shadcn/ui |
| グラフライブラリ | Recharts 2.15.2 |
| バックエンド | Ruby on Rails 8 (API mode) |
| データベース | PostgreSQL 16 |
| キャッシュ/セッション | Redis 7 |
| コンテナ | Docker + Docker Compose |

## 4. 主要要件サマリー

### 記録項目
- 体重
- 膝伸展筋力
- TUG (Timed Up and Go Test)
- 片脚立位
- 痛み（NRS）
- 筋力（MMT）
- 痛みレベル（0-10）
- 身体の調子（0-10）

### 入力者
- **利用者本人**: 運動記録、主観的な痛み・体調
- **職員**: 測定値、客観的評価

### アカウント
- 職員ごとに個別アカウント
- 役職別権限分け（マネージャー / 一般職員）

### 重要画面
- 履歴
- ウェルカム（継続日数表示）
- 祝福（達成感演出）

---

## 9. 実装状況 - Phase 1 完了 (2026-01-25)

### Phase 1 MVP 完了サマリー

| カテゴリ | 状態 | テスト | カバレッジ |
|---------|------|--------|----------|
| バックエンドAPI | ✅ 完了 | 372件 | 90.49% |
| 利用者向けUI | ✅ 完了 | 277件 | 97%+ |
| 職員向けUI | ✅ 完了 | 210件 | 95%+ |
| E2Eテスト | ✅ 完了 | 10ファイル | - |

### 完了した機能

#### 認証・セッション管理 ✅
- 利用者ログイン/ログアウト
- 職員ログイン/ログアウト
- セッションベース認証（利用者30分、職員15分タイムアウト）
- アカウントロックアウト（5回失敗で30分/15分ロック）
- パスワードリセット（トークンベース）
- 監査ログ記録

#### 運動記録機能 ✅
- 運動メニュー取得（利用者）
- 運動記録作成（利用者）
- 運動履歴取得（利用者）
- 継続日数自動計算（連続運動の追跡）

#### 体調記録機能 ✅
- 体調記録作成（利用者）
- 体調履歴取得（利用者）
- 痛みレベル・身体の調子を0-10で記録

#### 測定値管理機能 ✅
- 測定値入力（職員）
- 測定値履歴取得（職員・利用者）
- 日付フィルタ対応

#### 患者管理機能 ✅
- 患者一覧取得（職員）
  - ページネーション（デフォルト20件、最大100件）
  - 名前検索（部分一致）
  - ステータスフィルタ（急性期/回復期/維持期）
  - 権限制御（マネージャー: 全患者、一般職員: 担当患者のみ）
- 患者詳細取得（職員）
  - 担当職員情報含む（主担当/副担当）
  - PII暗号化対応（name, email, birth_date）
  - 監査ログ記録

#### 職員管理機能 ✅
- 職員一覧（マネージャーのみ）
- 職員作成（マネージャーのみ）
- 職員編集・削除

#### レポート機能 ✅
- 患者レポート生成（CSV）
- 測定値推移グラフ
- 運動実施状況サマリー

### データベーススキーマ

実装済みテーブル:
- `users` - 患者（利用者）
- `staff` - 職員
- `exercises` - 運動マスタ
- `patient_exercises` - 患者運動メニュー割当
- `exercise_records` - 運動記録
- `daily_conditions` - 体調記録
- `measurements` - 測定値
- `patient_staff_assignments` - 患者担当職員
- `audit_logs` - 監査ログ
- `password_reset_tokens` - パスワードリセットトークン

### セキュリティ実装

- ✅ PII暗号化（AES-256-GCM）
  - `users`: email, name, name_kana, birth_date
  - `staff`: email, name, name_kana
- ✅ Blind index（検索・ユニーク制約用）
- ✅ セッションベース認証
- ✅ アカウントロックアウト
- ✅ 監査ログ（全アクセス記録）
- ✅ パスワード複雑性チェック
- ✅ 権限ベースアクセス制御（マネージャー/一般職員）

### テストカバレッジ

#### バックエンド (RSpec)
- **全体**: 90.49% (932/1030 lines)
- **目標**: 80%以上 ✅
- **テストケース総数**: 372件

#### フロントエンド (Vitest)
- **利用者向け**: 97%+ (277テスト)
- **職員向け**: 95%+ (210テスト)
- **目標**: 80%以上 ✅

#### E2Eテスト (Playwright)
- **利用者向け**: 5テストファイル
- **職員向け**: 5テストファイル

---

## 10. フロントエンド実装状況 - 全画面完了 (2026-01-25)

### 利用者向けアプリ（frontend_user/）

| 画面 | コンポーネント | ステータス | テスト | カバレッジ |
|------|---------------|----------|--------|----------|
| U-01 ログイン | Login.tsx | ✅ 完了 | 19件 | 95.45% |
| U-02 ホーム | Home.tsx | ✅ 完了 | 23件 | 96.85% |
| U-03 運動メニュー | ExerciseMenu.tsx | ✅ 完了 | 16件 | 94.8% |
| U-04 運動実施 | ExercisePlayer.tsx | ✅ 完了 | 24件 | 95.96% |
| U-07 履歴一覧 | ExerciseHistory.tsx | ✅ 完了 | 19件 | 100% |
| U-08 測定値履歴 | Measurements.tsx | ✅ 完了 | 20件 | 99.59% |
| U-09 パスワードリセット | PasswordReset.tsx | ✅ 完了 | 31件 | 96.83% |
| U-10 ウェルカム | Welcome.tsx | ✅ 完了 | 21件 | 97.82% |
| U-11 運動カード | ExerciseCard.tsx | ✅ 完了 | 20件 | 100% |
| U-13 祝福 | Celebration.tsx | ✅ 完了 | 24件 | 100% |
| U-14 体調入力 | ConditionInput.tsx | ✅ 完了 | 27件 | 98.79% |
| U-15 まとめて記録 | BatchRecord.tsx | ✅ 完了 | 25件 | 98.17% |

**合計**: 12画面、277テスト、97%+カバレッジ

### 職員向けアプリ（frontend_admin/）

| 画面 | コンポーネント | ステータス | テスト | カバレッジ |
|------|---------------|----------|--------|----------|
| - | Sidebar.tsx | ✅ 完了 | 15件 | 100% |
| S-01 ログイン | Login.tsx | ✅ 完了 | 19件 | 95.54% |
| S-02 ダッシュボード | Dashboard.tsx | ✅ 完了 | 22件 | 100% |
| S-03 患者一覧 | PatientList.tsx | ✅ 完了 | 29件 | 97.9% |
| S-04 患者詳細 | PatientDetail.tsx | ✅ 完了 | 17件 | 97.51% |
| S-05 測定値入力 | MeasurementInput.tsx | ✅ 完了 | 22件 | 85.51% |
| S-06 運動メニュー設定 | ExerciseMenu.tsx | ✅ 完了 | 18件 | 88.67% |
| S-07 レポート出力 | ReportGeneration.tsx | ✅ 完了 | 14件 | 95.89% |
| S-08 職員管理 | StaffManagement.tsx | ✅ 完了 | 26件 | 95%+ |
| S-09 パスワードリセット | PasswordReset.tsx | ✅ 完了 | 28件 | 100% |

**合計**: 9画面、210テスト、95%+カバレッジ

### E2Eテスト (Playwright)

#### 利用者向け (frontend_user/e2e/)
- `01-login-logout.spec.ts` - ログイン・ログアウトフロー
- `02-exercise-flow.spec.ts` - 運動メニュー選択・実施・記録
- `03-condition-input.spec.ts` - 体調入力フロー
- `04-history.spec.ts` - 履歴一覧・測定値グラフ表示
- `05-password-reset.spec.ts` - パスワードリセットフロー

#### 職員向け (frontend_admin/e2e/)
- `01-login-logout.spec.ts` - ログイン・ログアウトフロー
- `02-patient-management.spec.ts` - 患者一覧・詳細表示
- `03-measurement-input.spec.ts` - 測定値入力フロー
- `04-exercise-menu.spec.ts` - 運動メニュー設定フロー
- `05-report-generation.spec.ts` - レポート出力フロー

### 次のステップ（Phase 2）

1. ~~パスワードリセットメール送信実装~~ ✅ 完了（2026-01-26）
2. ~~動画アクセス制御実装~~ ✅ 完了（2026-01-27）
3. ~~レート制限実装~~ ✅ 完了（2026-01-27）
4. ~~Docker環境構築~~ ✅ 完了（2026-01-27）
5. CI/CDパイプライン構築
6. 本番環境デプロイ
