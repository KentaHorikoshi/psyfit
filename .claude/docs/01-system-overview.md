# System Overview

## 1. プロジェクト背景

サイテック病院において、患者様が自宅でリハビリ運動を継続的に実施し、その結果を医療スタッフが効率的に確認・管理できるシステムを構築する。患者様の運動習慣の定着と、医療スタッフによる適切なフォローアップを実現することを目的とする。

## 2. システム利用シーン

### 利用者（患者様）

| 項目 | 内容 |
|------|------|
| 利用場所 | 自宅 |
| 利用タイミング | 日常の隙間時間、運動習慣として |
| デバイス | スマートフォン・タブレット |

**典型的な利用シーン:**

患者様は自宅で、朝または夕方などの隙間時間にスマートフォンやタブレットでアプリにアクセスします。ログイン後、ウェルカム画面（U-10）で継続日数を確認し、モチベーションを高めます。運動カード画面（U-11）に本日の運動メニューが表示されるので、動画を見ながら運動を実施します。完了後は祝福画面（U-13）で達成感を得て、体調入力画面（U-14）で当日の痛みレベルや体調を0〜10の数値で記録します。

### 職員（医療スタッフ）

| 項目 | 内容 |
|------|------|
| 利用場所 | 施設内 |
| 利用タイミング | 患者来院時（週1回〜月1回） |
| デバイス | PC・タブレット |

**典型的な利用シーン:**

医療スタッフは患者来院時（週1回〜月1回）に、施設内のタブレットやPCで測定値（膝伸展筋力、バランス評価など）を入力します。また、定期的にダッシュボードで担当患者の運動継続状況を確認し、必要に応じて運動メニューの調整や患者への声かけを行います。

## 3. システムスコープ

| 項目 | 内容 |
|------|------|
| 利用者向けアプリ | Webアプリ（スマートフォン・タブレット対応） |
| 職員向けアプリ | Webアプリ（PC・タブレット対応） |
| 動画配信 | 自社サーバー |
| 提供形態 | ブラウザベースのWebアプリケーション（SPA） |

### Tech Stack

| カテゴリ | 技術 |
|----------|------|
| フロントエンドフレームワーク | React 18 + TypeScript |
| ビルドツール | Vite 6.3.5 |
| CSSフレームワーク | Tailwind CSS v4 |
| UIコンポーネントライブラリ | Radix UI + shadcn/ui |
| グラフライブラリ | Recharts 2.15.2 |
| バックエンド | Ruby on Rails 8 (API mode) |
| データベース | PostgreSQL |

## 4. 主要要件サマリー

### 記録項目
- 体重
- 膝伸展筋力
- TUG (Timed Up and Go Test)
- 片脚立位
- 痛み（NRS）
- 筋力（MMT）
- 痛みレベル（0-10）
- 身体の調子（0-10）

### 入力者
- **利用者本人**: 運動記録、主観的な痛み・体調
- **職員**: 測定値、客観的評価

### アカウント
- 職員ごとに個別アカウント
- 役職別権限分け（マネージャー / 一般職員）

### 重要画面
- 履歴
- ウェルカム（継続日数表示）
- 祝福（達成感演出）

---

## 9. 実装状況（2026-01-23）

### 完了した機能

#### 認証・セッション管理 ✅
- 利用者ログイン/ログアウト
- 職員ログイン/ログアウト
- セッションベース認証（利用者30分、職員15分タイムアウト）
- アカウントロックアウト（5回失敗で30分/15分ロック）
- 監査ログ記録

#### 運動記録機能 ✅
- 運動メニュー取得（利用者）
- 運動記録作成（利用者）
- 運動履歴取得（利用者）
- 継続日数自動計算（連続運動の追跡）

#### 体調記録機能 ✅
- 体調記録作成（利用者）
- 体調履歴取得（利用者）
- 痛みレベル・身体の調子を0-10で記録

#### 測定値管理機能 ✅
- 測定値入力（職員）
- 測定値履歴取得（職員・利用者）
- 日付フィルタ対応

#### 患者管理機能 ✅ (2026-01-23)
- 患者一覧取得（職員）
  - ページネーション（デフォルト20件、最大100件）
  - 名前検索（部分一致）
  - ステータスフィルタ（急性期/回復期/維持期）
  - 権限制御（マネージャー: 全患者、一般職員: 担当患者のみ）
- 患者詳細取得（職員）
  - 担当職員情報含む（主担当/副担当）
  - PII暗号化対応（name, email, birth_date）
  - 監査ログ記録

### 未実装の機能

#### 運動メニュー割当 ⏳
- 職員による患者への運動メニュー割当
- 目標回数・セット数設定

#### レポート機能 ⏳
- 患者レポート生成（PDF）
- 測定値推移グラフ
- 運動実施状況サマリー

#### 職員管理機能 ⏳
- 職員一覧（マネージャーのみ）
- 職員作成（マネージャーのみ）
- 職員編集・削除

#### 利用者向けUI 🔄 (2026-01-24 開始)
- フロントエンド実装（React + TypeScript）
- ✅ U-01: ログイン画面
- ✅ U-02: ホーム画面（継続日数・メインメニュー）
- ⏳ U-03〜U-15: 未実装

#### 職員向けUI ⏳
- フロントエンド実装（React + TypeScript）
- 各画面のコンポーネント（S-01〜S-09）

### データベーススキーマ

実装済みテーブル:
- `users` - 患者（利用者）
- `staff` - 職員
- `exercises` - 運動マスタ
- `patient_exercises` - 患者運動メニュー割当
- `exercise_records` - 運動記録
- `daily_conditions` - 体調記録
- `measurements` - 測定値
- `patient_staff_assignments` - 患者担当職員 ✅ (2026-01-23)
- `audit_logs` - 監査ログ

### セキュリティ実装

- ✅ PII暗号化（AES-256-GCM）
  - `users`: email, name, name_kana, birth_date
  - `staff`: email, name, name_kana
- ✅ Blind index（検索・ユニーク制約用）
- ✅ セッションベース認証
- ✅ アカウントロックアウト
- ✅ 監査ログ（全アクセス記録）
- ✅ パスワード複雑性チェック
- ✅ 権限ベースアクセス制御（マネージャー/一般職員）

### テストカバレッジ

- **全体**: 86.52% (629/727 lines)
- **目標**: 80%以上 ✅
- **テストファイル数**: 7ファイル
- **テストケース総数**: 249例

主要テストファイル:
- `spec/requests/api/v1/auth_spec.rb` - 認証API
- `spec/requests/api/v1/user_exercises_spec.rb` - 運動メニューAPI
- `spec/requests/api/v1/exercise_records_spec.rb` - 運動記録API
- `spec/requests/api/v1/daily_conditions_spec.rb` - 体調記録API
- `spec/requests/api/v1/measurements_spec.rb` - 測定値API
- `spec/requests/api/v1/patients_spec.rb` - 患者管理API ✅ (2026-01-23)
- `spec/models/user_continue_days_spec.rb` - 継続日数ロジック

### 次の実装優先順位

1. ~~**運動メニュー割当API**~~ ✅ 完了
2. ~~**患者レポート生成API**~~ ✅ 完了
3. ~~**職員管理API**~~ ✅ 完了
4. **利用者向けUI** - React実装（U-03〜U-15画面）🔄 進行中
5. **職員向けUI** - React実装（S-01〜S-09画面）

---

## 10. フロントエンド実装状況（2026-01-24）

### 利用者向けアプリ（frontend_user/）

| 画面 | コンポーネント | ステータス | テスト | カバレッジ |
|------|---------------|----------|--------|----------|
| U-01 ログイン | Login.tsx | ✅ 完了 | ✅ 19件 | 95.45% |
| U-02 ホーム | Home.tsx | ✅ 完了 | ✅ 23件 | 96.85% |
| U-03 運動メニュー | - | ⏳ 未実装 | - | - |
| U-04 運動実施 | - | ⏳ 未実装 | - | - |
| U-07 履歴一覧 | - | ⏳ 未実装 | - | - |
| U-08 測定値履歴 | - | ⏳ 未実装 | - | - |
| U-09 パスワードリセット | - | ⏳ 未実装 | - | - |
| U-10 ウェルカム | - | ⏳ 未実装 | - | - |
| U-11 運動カード | - | ⏳ 未実装 | - | - |
| U-13 祝福 | - | ⏳ 未実装 | - | - |
| U-14 体調入力 | - | ⏳ 未実装 | - | - |
| U-15 まとめて記録 | - | ⏳ 未実装 | - | - |

**共通コンポーネント**:
- ✅ Button.tsx - ボタン（variant: primary/secondary/outline/ghost/danger）
- ✅ Input.tsx - 入力フィールド（label, error表示対応）

**コンテキスト**:
- ✅ AuthContext.tsx - 認証状態管理（ログイン/ログアウト、セッション管理）

**テスト結果**:
- 全テスト: 50件パス
- 全体カバレッジ: 97.17%
- 認証関連: 91.66%

**アクセシビリティ対応（WCAG 2.1 AA）**:
- ✅ 最小フォントサイズ: 16px
- ✅ タップ領域: 44×44px以上
- ✅ フォーカス表示: focus-visible対応
- ✅ ARIA属性: role, aria-label
- ✅ ランドマーク構造: header, main, nav
- ✅ セマンティックHTML: h1, section

**ファイル構成**:
```
frontend_user/
├── src/
│   ├── components/
│   │   ├── Home.tsx          # U-02 ホーム
│   │   ├── Login.tsx         # U-01 ログイン
│   │   ├── ui/
│   │   │   ├── Button.tsx    # ボタンコンポーネント
│   │   │   └── Input.tsx     # 入力コンポーネント
│   │   └── __tests__/
│   │       ├── Home.test.tsx
│   │       └── Login.test.tsx
│   ├── contexts/
│   │   ├── AuthContext.tsx   # 認証コンテキスト
│   │   └── __tests__/
│   │       └── AuthContext.test.tsx
│   ├── lib/
│   │   ├── api-client.ts     # APIクライアント
│   │   ├── api-types.ts      # 型定義
│   │   └── utils.ts          # ユーティリティ
│   └── test/
│       └── setup.ts          # テストセットアップ
├── vitest.config.ts
└── package.json
```

### 次のステップ

1. U-03〜U-15の実装
2. ルーティング設定（React Router）
3. API連携テスト
4. 職員向けUI実装開始
