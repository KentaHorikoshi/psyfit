# Security & Compliance Requirements

## 1. 認証・アクセス制御

### パスワードポリシー
- **最低文字数**: 8文字
- **文字種要件**: 英大文字・小文字・数字から2種類以上
- **有効期限**: 90日（職員アカウント）
- **再利用禁止**: 過去3回のパスワードは使用不可

### アカウントロックアウト
- **ロック条件**: ログイン失敗5回
- **ロック期間**: 30分間
- **解除方法**: 時間経過または管理者による手動解除

### セッション管理
- **利用者**: 30分無操作で自動ログアウト
- **職員**: 15分無操作で自動ログアウト
- **セッション更新**: アクティブ操作時に自動延長
- **セッションID**: 暗号学的に安全な乱数生成

### アクセスログ
- **記録対象**: 全ログイン試行、操作履歴
- **保存先**: audit_logs テーブル
- **保持期間**: 3年間
- **記録内容**:
  - ユーザーID
  - アクション種別
  - IPアドレス
  - タイムスタンプ
  - 結果（成功/失敗）

## 2. データ保護

### 個人情報暗号化
- **暗号化方式**: AES-256-GCM
- **暗号化対象フィールド**:
  - name (患者氏名)
  - name_kana (患者氏名カナ)
  - email (メールアドレス)
  - birth_date (生年月日)
- **鍵管理**: 環境変数による管理、定期ローテーション

### 通信暗号化
- **プロトコル**: HTTPS必須
- **TLS バージョン**: TLS 1.2以上
- **証明書**: 有効なSSL/TLS証明書
- **HSTS**: Strict-Transport-Security ヘッダー有効化

### データ削除
- **削除方式**: 論理削除（deleted_at フィールド）
- **保持期間**: 3年間
- **完全削除**: 保持期間経過後、バッチ処理で物理削除

## 3. 動画配信のアクセス制御

### 配信方式
- **格納先**: 自社サーバー内専用ストレージ
- **配信経路**: Rails APIサーバー経由の専用エンドポイント
- **直接アクセス**: 禁止（Webサーバー経由の直接アクセス不可）

### アクセス制御
```ruby
# 動画アクセス制御の実装方針
def authorize_video_access
  # 1. セッション認証確認
  return unauthorized unless session[:user_id]

  # 2. 患者への運動メニュー割り当て確認
  user = User.find(session[:user_id])
  video = Video.find(params[:video_id])

  return forbidden unless user.assigned_exercises.include?(video.exercise)

  # 3. 一時トークン生成（5分間有効）
  token = generate_temporary_token(user.id, video.id)

  # 4. トークン付きURL返却
  redirect_to video_stream_path(video_id: video.id, token: token)
end
```

### セキュリティ対策
- **セッション認証**: ログイン済みユーザーのみアクセス可能
- **割り当て確認**: 職員が患者に割り当てた運動動画のみ視聴可能
- **一時トークン**: 動画URL に5分間有効の使い捨てトークン付与
- **リファラーチェック**: アプリ内からのリクエストのみ許可

## 4. 権限制御

### 職員権限レベル
| 権限 | 役職 | アクセス範囲 |
|------|------|------------|
| Manager | マネージャー | 全機能アクセス可能、職員管理可能 |
| Staff | 一般職員 | 担当患者のみアクセス、職員管理不可 |

### 権限別機能一覧
| 機能 | Manager | Staff |
|------|---------|-------|
| ダッシュボード閲覧 | ✓ | ✓ |
| 担当患者情報閲覧 | ✓ | ✓ |
| 全患者情報閲覧 | ✓ | ✗ |
| 測定値入力 | ✓ | ✓（担当患者のみ） |
| 運動メニュー設定 | ✓ | ✓（担当患者のみ） |
| レポート出力 | ✓ | ✓（担当患者のみ） |
| 職員管理 | ✓ | ✗ |
| システム設定 | ✓ | ✗ |

## 5. 入力検証

### フロントエンド検証
- メールアドレス形式
- パスワード強度
- 数値範囲（0-10スライダー等）
- 必須項目チェック

### バックエンド検証
- **入力サニタイゼーション**: 全ユーザー入力をサニタイズ
- **SQLインジェクション対策**: パラメータ化クエリのみ使用
- **XSS対策**: HTMLエスケープ処理
- **CSRF対策**: トークン検証必須

```ruby
# バリデーション例
class Patient < ApplicationRecord
  validates :name, presence: true, length: { maximum: 100 }
  validates :email, presence: true, format: { with: URI::MailTo::EMAIL_REGEXP }
  validates :pain_level, numericality: {
    only_integer: true,
    greater_than_or_equal_to: 0,
    less_than_or_equal_to: 10
  }
end
```

## 6. 監査・コンプライアンス

### ログ記録
- **認証イベント**: ログイン成功/失敗
- **データアクセス**: 患者情報閲覧・編集
- **権限変更**: 職員権限の変更
- **データ削除**: 論理削除・物理削除

### コンプライアンス
- **個人情報保護法**: 適切な同意取得、目的外利用禁止
- **医療情報ガイドライン**: 3省2ガイドライン準拠
- **GDPR対応**: データポータビリティ、削除権対応

### インシデント対応
1. **検知**: 異常アクセスパターンの自動検知
2. **通知**: 管理者への即時通知
3. **調査**: ログ分析による原因究明
4. **対応**: アカウント停止、パスワードリセット強制
5. **報告**: インシデントレポート作成
