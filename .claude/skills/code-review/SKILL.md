# /code-review - Code Review Skill

コード品質とセキュリティのレビュースキル。

## 使用方法

```
/code-review [ファイルパスまたはPR番号]
```

## レビューチェックリスト

### 1. コード品質

#### 構造・設計

- [ ] ファイルサイズは適切か（200-400行推奨、800行上限）
- [ ] 単一責任原則に従っているか
- [ ] 適切な命名がされているか
- [ ] 不要なコードがないか（デッドコード、未使用import）
- [ ] DRY原則に従っているか（重複コードがないか）

#### 可読性

- [ ] ロジックが理解しやすいか
- [ ] 必要な箇所にコメントがあるか
- [ ] 複雑な処理は適切に分割されているか
- [ ] マジックナンバー/マジックストリングがないか

#### エラーハンドリング

- [ ] 適切な例外処理があるか
- [ ] エラーメッセージが適切か
- [ ] エッジケースが考慮されているか

### 2. セキュリティ

#### 認証・認可

- [ ] 認証が必要なエンドポイントに `authenticate_user!` / `authenticate_staff!` があるか
- [ ] 権限チェックが適切か（Pundit使用）
- [ ] セッション管理が適切か

#### 入力検証

- [ ] ユーザー入力がサニタイズされているか
- [ ] バリデーションが適切か
- [ ] SQLインジェクション対策（パラメータ化クエリ）
- [ ] XSS対策（HTMLエスケープ）

#### 機密情報

- [ ] パスワード/APIキーがハードコードされていないか
- [ ] 機密情報がログに出力されていないか
- [ ] 暗号化が必要なデータが暗号化されているか

#### OWASP Top 10

- [ ] A01: アクセス制御の不備
- [ ] A02: 暗号化の失敗
- [ ] A03: インジェクション
- [ ] A04: 安全でない設計
- [ ] A05: セキュリティ設定ミス

### 3. アクセシビリティ（フロントエンド）

- [ ] セマンティックHTMLを使用しているか
- [ ] `aria-label`, `role` 属性が適切か
- [ ] キーボード操作が可能か
- [ ] フォーカス状態が視覚的に分かるか
- [ ] 最小タップ領域（44×44px）を満たしているか
- [ ] コントラスト比が4.5:1以上か

### 4. パフォーマンス

#### バックエンド

- [ ] N+1クエリがないか（`includes`使用）
- [ ] 不要なデータを取得していないか
- [ ] インデックスが適切に使用されているか
- [ ] キャッシュを活用しているか

#### フロントエンド

- [ ] 不要な再レンダリングがないか（`useMemo`, `useCallback`）
- [ ] Code Splittingが適切か
- [ ] 画像が最適化されているか
- [ ] バンドルサイズが適切か

### 5. テスト

- [ ] 新機能にテストがあるか
- [ ] エッジケースがカバーされているか
- [ ] テストが意味のあるアサーションを含むか
- [ ] テストカバレッジが維持されているか（80%以上）

## レビューコメントテンプレート

### 必須修正（Must Fix）

```
🔴 **必須修正**: [問題の説明]

[問題のあるコード]

[修正案]
```

### 推奨修正（Should Fix）

```
🟡 **推奨修正**: [問題の説明]

[理由]

[修正案]
```

### 提案（Nice to Have）

```
🟢 **提案**: [提案の説明]

[理由]
```

### 質問

```
❓ **質問**: [質問内容]
```

## レビュー例

### セキュリティ問題

```ruby
# 🔴 必須修正: SQLインジェクション脆弱性
# Before
User.where("name LIKE '%#{params[:search]}%'")

# After
User.where('name LIKE ?', "%#{sanitize_sql_like(params[:search])}%")
```

### パフォーマンス問題

```ruby
# 🟡 推奨修正: N+1クエリ
# Before
patients.each { |p| p.staff.name }

# After
patients.includes(:staff).each { |p| p.staff.name }
```

### アクセシビリティ問題

```tsx
// 🔴 必須修正: ボタンにaria-labelがない
// Before
<button onClick={handleClick}>
  <Icon name="close" />
</button>

// After
<button onClick={handleClick} aria-label="閉じる">
  <Icon name="close" />
</button>
```

### コード品質

```typescript
// 🟢 提案: 定数を抽出して可読性向上
// Before
if (value > 10) { ... }

// After
const MAX_PAIN_LEVEL = 10;
if (value > MAX_PAIN_LEVEL) { ... }
```

## 自動チェックツール

### バックエンド

```bash
# RuboCop（スタイルチェック）
bundle exec rubocop

# Brakeman（セキュリティチェック）
bundle exec brakeman

# RSpec（テスト）
bundle exec rspec
```

### フロントエンド

```bash
# ESLint
npm run lint

# TypeScript
npm run type-check

# テスト
npm run test
```

## レビュー完了条件

- [ ] 必須修正がすべて対応済み
- [ ] 推奨修正が対応済み（または理由付きでスキップ）
- [ ] すべてのテストがパス
- [ ] CI/CDがグリーン
