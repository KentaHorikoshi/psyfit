#!/bin/sh

# post-deploy hook
#
# デプロイ完了後にヘルスチェックを実行してアプリケーションの稼働を確認する。
#
# These environment variables are available:
# KAMAL_RECORDED_AT
# KAMAL_PERFORMER
# KAMAL_VERSION
# KAMAL_HOSTS
# KAMAL_ROLES (if set)
# KAMAL_DESTINATION (if set)
# KAMAL_RUNTIME

echo "$KAMAL_PERFORMER deployed $KAMAL_VERSION in $KAMAL_RUNTIME seconds"

HEALTH_URL="https://psytech.jp/api/v1/health"
MAX_ATTEMPTS=12
SLEEP_SECONDS=5

echo "Verifying deployment health at ${HEALTH_URL} ..."

i=1
while [ "$i" -le "$MAX_ATTEMPTS" ]; do
  HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$HEALTH_URL" 2>/dev/null || echo "000")

  if [ "$HTTP_STATUS" = "200" ]; then
    echo "Health check passed (HTTP ${HTTP_STATUS}) after $((i * SLEEP_SECONDS))s"
    exit 0
  fi

  echo "Health check attempt ${i}/${MAX_ATTEMPTS}: HTTP ${HTTP_STATUS}, retrying in ${SLEEP_SECONDS}s..."
  sleep "$SLEEP_SECONDS"
  i=$((i + 1))
done

echo "ERROR: Health check failed after $((MAX_ATTEMPTS * SLEEP_SECONDS))s. Last HTTP status: ${HTTP_STATUS}" >&2
exit 1
