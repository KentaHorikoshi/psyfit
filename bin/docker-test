#!/bin/bash
set -e

# Docker環境テストスクリプト
# 各サービスのビルド・起動・ヘルスチェックを検証する

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

PASS=0
FAIL=0
SKIP=0

pass() {
  echo -e "  ${GREEN}✓${NC} $1"
  PASS=$((PASS + 1))
}

fail() {
  echo -e "  ${RED}✗${NC} $1"
  FAIL=$((FAIL + 1))
}

skip() {
  echo -e "  ${YELLOW}-${NC} $1 (skipped)"
  SKIP=$((SKIP + 1))
}

section() {
  echo ""
  echo "━━━ $1 ━━━"
}

# ========================================
# 1. ファイル存在チェック
# ========================================
section "File Existence Tests"

check_file() {
  if [ -f "$1" ]; then
    pass "$1 exists"
  else
    fail "$1 not found"
  fi
}

check_executable() {
  if [ -x "$1" ]; then
    pass "$1 is executable"
  else
    fail "$1 is not executable"
  fi
}

check_file "Dockerfile"
check_file "Dockerfile.dev"
check_file "docker-compose.yml"
check_file "docker-compose.prod.yml"
check_file ".env.example"
check_file ".env.docker"
check_file ".dockerignore"
check_executable "bin/docker-setup"
check_executable "bin/docker-start"
check_executable "bin/docker-test"

# ========================================
# 2. Docker Compose設定の検証
# ========================================
section "Docker Compose Configuration Tests"

# docker-compose.yml syntax check
if docker compose -f docker-compose.yml config > /dev/null 2>&1; then
  pass "docker-compose.yml is valid"
else
  fail "docker-compose.yml has syntax errors"
fi

# docker-compose.prod.yml syntax check
if docker compose -f docker-compose.prod.yml config > /dev/null 2>&1; then
  pass "docker-compose.prod.yml is valid"
else
  fail "docker-compose.prod.yml has syntax errors"
fi

# ========================================
# 3. サービス定義チェック（開発環境）
# ========================================
section "Development Services Definition Tests"

check_service() {
  local file=$1
  local service=$2
  if docker compose -f "$file" config --services 2>/dev/null | grep -q "^${service}$"; then
    pass "$service service defined in $file"
  else
    fail "$service service missing in $file"
  fi
}

check_service "docker-compose.yml" "api"
check_service "docker-compose.yml" "db"
check_service "docker-compose.yml" "redis"
check_service "docker-compose.yml" "frontend_user"
check_service "docker-compose.yml" "frontend_admin"

# ========================================
# 4. サービス定義チェック（本番環境）
# ========================================
section "Production Services Definition Tests"

check_service "docker-compose.prod.yml" "api"
check_service "docker-compose.prod.yml" "db"
check_service "docker-compose.prod.yml" "redis"

# ========================================
# 5. ポートマッピング検証
# ========================================
section "Port Mapping Tests"

check_port() {
  local file=$1
  local service=$2
  local port=$3
  if docker compose -f "$file" config 2>/dev/null | grep -A 20 "  ${service}:" | grep -q "${port}"; then
    pass "$service exposes port $port in $file"
  else
    fail "$service does not expose port $port in $file"
  fi
}

check_port "docker-compose.yml" "api" "4001"
check_port "docker-compose.yml" "db" "5432"
check_port "docker-compose.yml" "redis" "6379"
check_port "docker-compose.yml" "frontend_user" "3000"
check_port "docker-compose.yml" "frontend_admin" "3003"

# ========================================
# 6. 環境変数テンプレート検証
# ========================================
section "Environment Variable Template Tests"

check_env_var() {
  local file=$1
  local var=$2
  if grep -q "^${var}=" "$file" 2>/dev/null; then
    pass "$var defined in $file"
  else
    fail "$var missing in $file"
  fi
}

check_env_var ".env.example" "POSTGRES_USER"
check_env_var ".env.example" "POSTGRES_PASSWORD"
check_env_var ".env.example" "POSTGRES_HOST"
check_env_var ".env.example" "REDIS_URL"
check_env_var ".env.example" "RAILS_MASTER_KEY"
check_env_var ".env.example" "RAILS_ENV"

check_env_var ".env.docker" "POSTGRES_USER"
check_env_var ".env.docker" "POSTGRES_PASSWORD"
check_env_var ".env.docker" "POSTGRES_HOST"
check_env_var ".env.docker" "REDIS_URL"

# ========================================
# 7. セキュリティチェック
# ========================================
section "Security Tests"

# .env.docker should NOT contain production secrets
if grep -qi "production" ".env.docker" 2>/dev/null && grep -qi "real_password\|actual_key" ".env.docker" 2>/dev/null; then
  fail ".env.docker contains production secrets"
else
  pass ".env.docker does not contain production secrets"
fi

# .gitignore should ignore .env files (but not .env.example and .env.docker)
if grep -q "\.env" ".gitignore" 2>/dev/null; then
  pass ".gitignore includes .env pattern"
else
  fail ".gitignore missing .env pattern"
fi

# Dockerfile should not contain hardcoded secrets
if grep -Eiq "(password|secret|key)\s*=" "Dockerfile.dev" 2>/dev/null; then
  fail "Dockerfile.dev may contain hardcoded secrets"
else
  pass "Dockerfile.dev has no hardcoded secrets"
fi

# ========================================
# 8. ボリュームとヘルスチェック
# ========================================
section "Volume and Healthcheck Tests"

# Check volumes in dev compose
if docker compose -f docker-compose.yml config 2>/dev/null | grep -q "pgdata"; then
  pass "PostgreSQL data volume defined"
else
  fail "PostgreSQL data volume missing"
fi

if docker compose -f docker-compose.yml config 2>/dev/null | grep -q "redis_data"; then
  pass "Redis data volume defined"
else
  fail "Redis data volume missing"
fi

# Check healthcheck in prod compose
if docker compose -f docker-compose.prod.yml config 2>/dev/null | grep -q "healthcheck"; then
  pass "Healthcheck configured in production"
else
  fail "Healthcheck missing in production"
fi

# ========================================
# 9. Dockerfileビルドテスト（オプション）
# ========================================
section "Dockerfile Build Tests"

if [ "${DOCKER_BUILD_TEST:-false}" = "true" ]; then
  echo "  Building Dockerfile.dev..."
  if docker build -f Dockerfile.dev -t psyfit-dev-test . > /dev/null 2>&1; then
    pass "Dockerfile.dev builds successfully"
    docker rmi psyfit-dev-test > /dev/null 2>&1 || true
  else
    fail "Dockerfile.dev build failed"
  fi
else
  skip "Dockerfile.dev build (set DOCKER_BUILD_TEST=true to enable)"
fi

# ========================================
# 10. Docker Compose起動テスト（オプション）
# ========================================
section "Docker Compose Up Tests"

if [ "${DOCKER_UP_TEST:-false}" = "true" ]; then
  echo "  Starting services..."
  if docker compose -f docker-compose.yml up -d --build > /dev/null 2>&1; then
    pass "docker compose up succeeded"

    # Wait for services to be ready
    sleep 10

    # Check DB health
    if docker compose -f docker-compose.yml exec -T db pg_isready -U psyfit > /dev/null 2>&1; then
      pass "PostgreSQL is accepting connections"
    else
      fail "PostgreSQL is not ready"
    fi

    # Check Redis health
    if docker compose -f docker-compose.yml exec -T redis redis-cli ping 2>/dev/null | grep -q "PONG"; then
      pass "Redis is responding"
    else
      fail "Redis is not responding"
    fi

    # Check API health
    if curl -sf http://localhost:4001/api/v1/health > /dev/null 2>&1; then
      pass "API health endpoint responds"
    else
      skip "API health endpoint (may need DB setup)"
    fi

    # Cleanup
    docker compose -f docker-compose.yml down -v > /dev/null 2>&1
    pass "Cleanup completed"
  else
    fail "docker compose up failed"
  fi
else
  skip "Docker Compose up test (set DOCKER_UP_TEST=true to enable)"
fi

# ========================================
# Results
# ========================================
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "Results: ${GREEN}${PASS} passed${NC}, ${RED}${FAIL} failed${NC}, ${YELLOW}${SKIP} skipped${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

if [ $FAIL -gt 0 ]; then
  exit 1
fi
